package com.incquerylabs.emdw.cpp.codegeneration.templates

import com.ericsson.xtumlrt.oopl.cppmodel.CPPDirectory
import com.ericsson.xtumlrt.oopl.cppmodel.CPPModel
import java.util.List

class MakefileTemplates {
	
	def makefileTemplate(CPPModel model, List<String> otherSubDirs) '''
	##############################################################################
	# M A K E F I L E
	#
	# NAME: «model.cppName»
	#
	# Generated by EMDW-MC
	#
	##############################################################################
	
	CXX=g++
	LDFLAGS=
	MAKE=make
	«IF false»
	# IF HAS INCLUDED PROJECT
	CXXFLAGS=-O3 -Wall -Wextra -I. -I(../)*[INCLUDED_PROJECT]/
	LIBPATH=-L"(../)*[INCLUDED_PROJECT]/[Release/Debug]" -Wl,-rpath,"(../)*[INCLUDED_PROJECT]/[Release/Debug]"
	LIBS=$(LIBPATH) -l[INCLUDED_PROJECT]
	«ELSE»
	CXXFLAGS=-O3 -Wall -Wextra -I.
	LIBS=-lrt
	«ENDIF»
	
	COMPILE=$(CXX) $(CXXFLAGS) -c -o $@ $<
	LINK=$(CXX) $(LDFLAGS) -o $@ $^ $(LIBS)
	
	.SUFFIXES:
	.SUFFIXES: .cc .hh .o
	
	SOURCES := $(wildcard *.cc)
	OBJECTS := $(SOURCES:%.cc=%.o)
	BINARY := «model.cppName».out
	
	d :=	.
	
	dir := 	$(d)/«model.headerDir.name»
	include $(dir)/Rules.mk
	«IF model.headerDir!=model.bodyDir»
	dir := 	$(d)/«model.bodyDir.name»
	include $(dir)/Rules.mk
	«ENDIF»
	«FOR subDir : otherSubDirs»
	dir := 	$(d)/«subDir»
	include $(dir)/Rules.mk
	«ENDFOR»
	
	%.o:	%.cc
			$(COMPILE)
			
	$(BINARY): $(OBJECTS)
			$(LINK)
			
	.PHONY: all
	all: $(SOURCES) $(OBJECTS) $(BINARY)
	
	.PHONY: clean
	clean:
		rm -f $(OBJECTS) $(BINARY)
	'''
	
	def rulesMkTemplate(CPPDirectory dir)'''
	##############################################################################
	# [M O D E L / C O M P O N E N T / P A C K A G E]   M A K E   R U L E S
	#
	# NAME: «dir.name»
	#
	# Generated by EMDW-MC
	#
	##############################################################################
	
	sp				:= $(sp).x
	dirstack_$(sp)	:= $(d)
	d				:= $(dir)
	
	«FOR subDir : dir.subDirectories»
	dir := 	$(d)/«subDir.name»
	include $(dir)/Rules.mk
	«ENDFOR»
	
	
	SOURCES_$(d)	:= $(wildcard $(d)/*.cc)
	OBJECTS_$(d)	:= $(SOURCES_$(d):%.cc=%.o)
	
	SOURCES	:= $(SOURCES) $(SOURCES_$(d))
	OBJECTS	:= $(OBJECTS) $(OBJECTS_$(d))
	
	d	:= $(dirstack_$(sp))
	sp	:= $(basename $(sp))
	'''
}